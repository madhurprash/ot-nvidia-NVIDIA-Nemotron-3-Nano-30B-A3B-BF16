Get:1 http://archive.ubuntu.com/ubuntu noble InRelease [256 kB]
Get:2 http://security.ubuntu.com/ubuntu noble-security InRelease [126 kB]
Get:3 http://archive.ubuntu.com/ubuntu noble-updates InRelease [126 kB]
Get:4 http://archive.ubuntu.com/ubuntu noble-backports InRelease [126 kB]
Get:5 http://archive.ubuntu.com/ubuntu noble/universe amd64 Packages [19.3 MB]
Get:6 http://security.ubuntu.com/ubuntu noble-security/universe amd64 Packages [1188 kB]
Get:7 http://archive.ubuntu.com/ubuntu noble/main amd64 Packages [1808 kB]
Get:8 http://archive.ubuntu.com/ubuntu noble/multiverse amd64 Packages [331 kB]
Get:9 http://archive.ubuntu.com/ubuntu noble/restricted amd64 Packages [117 kB]
Get:10 http://archive.ubuntu.com/ubuntu noble-updates/universe amd64 Packages [1955 kB]
Get:11 http://archive.ubuntu.com/ubuntu noble-updates/main amd64 Packages [2137 kB]
Get:12 http://archive.ubuntu.com/ubuntu noble-updates/multiverse amd64 Packages [35.9 kB]
Get:13 http://archive.ubuntu.com/ubuntu noble-updates/restricted amd64 Packages [3064 kB]
Get:14 http://archive.ubuntu.com/ubuntu noble-backports/universe amd64 Packages [34.6 kB]
Get:15 http://archive.ubuntu.com/ubuntu noble-backports/main amd64 Packages [49.5 kB]
Get:16 http://security.ubuntu.com/ubuntu noble-security/main amd64 Packages [1762 kB]
Get:17 http://security.ubuntu.com/ubuntu noble-security/restricted amd64 Packages [2905 kB]
Get:18 http://security.ubuntu.com/ubuntu noble-security/multiverse amd64 Packages [33.1 kB]
Fetched 35.4 MB in 3s (11.4 MB/s)
Reading package lists...
Reading package lists...
Building dependency tree...
Reading state information...
The following additional packages will be installed:
  libbrotli1 libcurl4t64 libnghttp2-14 libpsl5t64 librtmp1 libssh-4
The following NEW packages will be installed:
  curl libbrotli1 libcurl4t64 libnghttp2-14 libpsl5t64 librtmp1 libssh-4
0 upgraded, 7 newly installed, 0 to remove and 33 not upgraded.
Need to get 1274 kB of archives.
After this operation, 3299 kB of additional disk space will be used.
Get:1 http://archive.ubuntu.com/ubuntu noble-updates/main amd64 libnghttp2-14 amd64 1.59.0-1ubuntu0.2 [74.3 kB]
Get:2 http://archive.ubuntu.com/ubuntu noble/main amd64 libpsl5t64 amd64 0.21.2-1.1build1 [57.1 kB]
Get:3 http://archive.ubuntu.com/ubuntu noble/main amd64 libbrotli1 amd64 1.1.0-2build2 [331 kB]
Get:4 http://archive.ubuntu.com/ubuntu noble/main amd64 librtmp1 amd64 2.4+20151223.gitfa8646d.1-2build7 [56.3 kB]
Get:5 http://archive.ubuntu.com/ubuntu noble-updates/main amd64 libssh-4 amd64 0.10.6-2ubuntu0.2 [188 kB]
Get:6 http://archive.ubuntu.com/ubuntu noble-updates/main amd64 libcurl4t64 amd64 8.5.0-2ubuntu10.6 [341 kB]
Get:7 http://archive.ubuntu.com/ubuntu noble-updates/main amd64 curl amd64 8.5.0-2ubuntu10.6 [226 kB]
Fetched 1274 kB in 1s (907 kB/s)
Selecting previously unselected package libnghttp2-14:amd64.
(Reading database ... (Reading database ... 5%(Reading database ... 10%(Reading database ... 15%(Reading database ... 20%(Reading database ... 25%(Reading database ... 30%(Reading database ... 35%(Reading database ... 40%(Reading database ... 45%(Reading database ... 50%(Reading database ... 55%(Reading database ... 60%(Reading database ... 65%(Reading database ... 70%(Reading database ... 75%(Reading database ... 80%(Reading database ... 85%(Reading database ... 90%(Reading database ... 95%(Reading database ... 100%(Reading database ... 13677 files and directories currently installed.)
Preparing to unpack .../0-libnghttp2-14_1.59.0-1ubuntu0.2_amd64.deb ...
Unpacking libnghttp2-14:amd64 (1.59.0-1ubuntu0.2) ...
Selecting previously unselected package libpsl5t64:amd64.
Preparing to unpack .../1-libpsl5t64_0.21.2-1.1build1_amd64.deb ...
Unpacking libpsl5t64:amd64 (0.21.2-1.1build1) ...
Selecting previously unselected package libbrotli1:amd64.
Preparing to unpack .../2-libbrotli1_1.1.0-2build2_amd64.deb ...
Unpacking libbrotli1:amd64 (1.1.0-2build2) ...
Selecting previously unselected package librtmp1:amd64.
Preparing to unpack .../3-librtmp1_2.4+20151223.gitfa8646d.1-2build7_amd64.deb ...
Unpacking librtmp1:amd64 (2.4+20151223.gitfa8646d.1-2build7) ...
Selecting previously unselected package libssh-4:amd64.
Preparing to unpack .../4-libssh-4_0.10.6-2ubuntu0.2_amd64.deb ...
Unpacking libssh-4:amd64 (0.10.6-2ubuntu0.2) ...
Selecting previously unselected package libcurl4t64:amd64.
Preparing to unpack .../5-libcurl4t64_8.5.0-2ubuntu10.6_amd64.deb ...
Unpacking libcurl4t64:amd64 (8.5.0-2ubuntu10.6) ...
Selecting previously unselected package curl.
Preparing to unpack .../6-curl_8.5.0-2ubuntu10.6_amd64.deb ...
Unpacking curl (8.5.0-2ubuntu10.6) ...
Setting up libbrotli1:amd64 (1.1.0-2build2) ...
Setting up libpsl5t64:amd64 (0.21.2-1.1build1) ...
Setting up libnghttp2-14:amd64 (1.59.0-1ubuntu0.2) ...
Setting up librtmp1:amd64 (2.4+20151223.gitfa8646d.1-2build7) ...
Setting up libssh-4:amd64 (0.10.6-2ubuntu0.2) ...
Setting up libcurl4t64:amd64 (8.5.0-2ubuntu10.6) ...
Setting up curl (8.5.0-2ubuntu10.6) ...
Processing triggers for libc-bin (2.39-0ubuntu8.6) ...
no checksums to verify
installing to /root/.local/bin
  uv
  uvx
everything's installed!

To add $HOME/.local/bin to your PATH, either restart your shell or run:

    source $HOME/.local/bin/env (sh, bash, zsh)
    source $HOME/.local/bin/env.fish (fish)
============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-8.4.1, pluggy-1.6.0
rootdir: /tests
plugins: json-ctrf-0.3.5
collected 3 items

../tests/test_outputs.py F.F                                             [100%]

=================================== FAILURES ===================================
__________________________ test_simple_local_delivery __________________________

    def test_simple_local_delivery():
        """Test that postfix can deliver mail to local users
        and that the email content is accessible in their local mailboxes.
        """
        user = "bobgreen"
        add_user(user)
        mbox_path = f"/var/mail/{user}"
        subject = "Direct Message"
        send_email(
            from_addr=f"{user}@{DOMAIN_NAME}",
            to_addr=f"{user}@{DOMAIN_NAME}",
            subject=subject,
            body="Direct test message",
        )
    
        def _assert_mailbox_exists():
            assert os.path.exists(mbox_path), f"Mailbox not found: {mbox_path}"
    
        def _assert_receipt():
            mbox = mailbox.mbox(mbox_path)
            found = any(email_msg.get("Subject", "") == subject for email_msg in mbox)
            assert found, f"Direct email not found in {mbox_path}"
    
>       retry(_assert_mailbox_exists)

/tests/test_outputs.py:159: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/tests/test_outputs.py:52: in retry
    raise e
/tests/test_outputs.py:48: in retry
    return func()
           ^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

    def _assert_mailbox_exists():
>       assert os.path.exists(mbox_path), f"Mailbox not found: {mbox_path}"
E       AssertionError: Mailbox not found: /var/mail/bobgreen
E       assert False
E        +  where False = <function exists at 0x7d71e5acf560>('/var/mail/bobgreen')
E        +    where <function exists at 0x7d71e5acf560> = <module 'posixpath' (frozen)>.exists
E        +      where <module 'posixpath' (frozen)> = os.path

/tests/test_outputs.py:152: AssertionError
----------------------------- Captured stdout call -----------------------------
bobgreen added successfully.
Retrying in 2 seconds...
Retrying in 4 seconds...
Retrying in 8 seconds...
Retrying in 16 seconds...
________________________ test_join_announce_leave_flow _________________________

    def test_join_announce_leave_flow():
        """Full flow of user joining, announcing, and leaving the mailing list."""
        subject = "Secret Announcement"
        user = "alicegray"
        add_user(user)
        mbox_path = f"/var/mail/{user}"
    
        def _assert_mailbox_exists():
            assert os.path.exists(mbox_path), f"Mailbox not found: {mbox_path}"
    
        def _assert_not_member():
            mlist = get_mlist()
            user_member = mlist.members.get_member(f"{user}@{DOMAIN_NAME}")
            assert user_member is None, f"{user} is a member: {user_member=}"
    
        def _assert_member():
            mlist = get_mlist()
            user_member = mlist.members.get_member(f"{user}@{DOMAIN_NAME}")
            assert user_member, f"{user} is not a member: {user_member=}"
    
        def _assert_announcement():
            mbox = mailbox.mbox(mbox_path)
            announce_msgs = [msg for msg in mbox if subject in msg.get("Subject", "")]
            assert len(announce_msgs) == 1, (
                f"Expected 1 announcement, found {len(announce_msgs)}"
            )
    
        send_email(
            body="",
            subject="",
            from_addr=f"{user}@{DOMAIN_NAME}",
            to_addr=JOIN_LIST,
        )
        print(f"{user} sends a join request")
        retry(_assert_not_member)
        print(f"{user} has not yet confirmed their subscription")
    
>       retry(_assert_mailbox_exists)

/tests/test_outputs.py:207: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/tests/test_outputs.py:52: in retry
    raise e
/tests/test_outputs.py:48: in retry
    return func()
           ^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

    def _assert_mailbox_exists():
>       assert os.path.exists(mbox_path), f"Mailbox not found: {mbox_path}"
E       AssertionError: Mailbox not found: /var/mail/alicegray
E       assert False
E        +  where False = <function exists at 0x7d71e5acf560>('/var/mail/alicegray')
E        +    where <function exists at 0x7d71e5acf560> = <module 'posixpath' (frozen)>.exists
E        +      where <module 'posixpath' (frozen)> = os.path

/tests/test_outputs.py:178: AssertionError
----------------------------- Captured stdout call -----------------------------
alicegray added successfully.
alicegray sends a join request
alicegray has not yet confirmed their subscription
Retrying in 2 seconds...
Retrying in 4 seconds...
Retrying in 8 seconds...
Retrying in 16 seconds...
=============================== warnings summary ===============================
test_outputs.py::test_mlist_exists
  /app/.tb/lib/python3.12/site-packages/mailman/database/model.py:56: MovedIn20Warning: The ``declarative_base()`` function is now available as sqlalchemy.orm.declarative_base(). (deprecated since: 2.0) (Background on SQLAlchemy 2.0 at: https://sqlalche.me/e/b8d9)
    Model = declarative_base(cls=ModelMeta)

test_outputs.py::test_mlist_exists
  /app/.tb/lib/python3.12/site-packages/passlib/utils/__init__.py:854: DeprecationWarning: 'crypt' is deprecated and slated for removal in Python 3.13
    from crypt import crypt as _crypt

test_outputs.py::test_mlist_exists
test_outputs.py::test_mlist_exists
test_outputs.py::test_mlist_exists
test_outputs.py::test_mlist_exists
test_outputs.py::test_mlist_exists
test_outputs.py::test_mlist_exists
  /app/.tb/lib/python3.12/site-packages/importlib_resources/_functional.py:57: DeprecationWarning: importlib.resources.contents is deprecated. Use files(anchor).iterdir() instead.
    warnings.warn(

test_outputs.py::test_mlist_exists
  /app/.tb/lib/python3.12/site-packages/mailman/commands/cli_gatenews.py:24: DeprecationWarning: 'nntplib' is deprecated and slated for removal in Python 3.13
    import nntplib

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
==================================== PASSES ====================================
=========================== short test summary info ============================
PASSED ../tests/test_outputs.py::test_mlist_exists
FAILED ../tests/test_outputs.py::test_simple_local_delivery - AssertionError:...
FAILED ../tests/test_outputs.py::test_join_announce_leave_flow - AssertionErr...
============== 2 failed, 1 passed, 9 warnings in 63.15s (0:01:03) ==============
