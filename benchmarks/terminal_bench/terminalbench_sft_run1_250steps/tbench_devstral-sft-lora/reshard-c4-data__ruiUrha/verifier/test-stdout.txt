============================= test session starts ==============================
platform linux -- Python 3.13.7, pytest-8.4.1, pluggy-1.6.0
rootdir: /tests
plugins: anyio-4.12.1, json-ctrf-0.3.5
collected 1 item

../tests/test_outputs.py F                                               [100%]

=================================== FAILURES ===================================
______________________ test_compress_decompress_workflow _______________________

generate_test_data = {'c4-mini-00000-of-10000.jsonl': '755f90ce91ae322c2643712308e12d120ca079180bf0d5180accfe7342ec2ee3', 'c4-mini-00001-of...3db97db8f138', 'c4-mini-00003-of-10000.jsonl': 'a7e4c98cecbca03fe6bcb719cfa252c6629c613863058da907cda1311f53342b', ...}

    def test_compress_decompress_workflow(generate_test_data):
        """Test the full compress -> decompress workflow is successful."""
        original_hashes = generate_test_data
    
        # Part 1: Test compression
        # Clean up output directory
        if os.path.exists(TEST_OUTPUT_DIR):
            shutil.rmtree(TEST_OUTPUT_DIR)
    
        # Install dependencies first to avoid snapshot contamination
        print("Installing dependencies with uv sync...")
        sync_result = subprocess.run(["uv", "sync"], capture_output=True, text=True)
        if sync_result.returncode != 0:
            print(f"uv sync failed: {sync_result.stderr}")
    
        # Run the compress script
        try:
            print(
                f"Running compress script: {COMPRESS_SCRIPT} "
                f"{TEST_INPUT_DIR} {TEST_OUTPUT_DIR}"
            )
            result = subprocess.run(
                ["uv", "run", COMPRESS_SCRIPT, TEST_INPUT_DIR, TEST_OUTPUT_DIR],
                timeout=600,
                capture_output=True,
                text=True,
            )
            if result.returncode != 0:
                print(f"Compress script failed with return code {result.returncode}")
                print(f"stdout: {result.stdout}")
                print(f"stderr: {result.stderr}")
>               assert False, f"Compress script failed: {result.stderr}"
E               AssertionError: Compress script failed: warning: No `requires-python` value found in the workspace. Defaulting to `>=3.13`.
E                    Building reshape-tools @ file:///app
E                   × Failed to build `reshape-tools @ file:///app`
E                   ├─▶ The build backend returned an error
E                   ╰─▶ Call to `hatchling.build.build_editable` failed (exit status: 1)
E                 
E                       [stderr]
E                       Traceback (most recent call last):
E                         File "<string>", line 11, in <module>
E                           wheel_filename =
E                       backend.build_editable("/root/.cache/uv/builds-v0/.tmp7UtIFd", {}, None)
E                         File
E                       "/root/.cache/uv/builds-v0/.tmpAuVeyE/lib/python3.13/site-packages/hatchling/build.py",
E                       line 83, in build_editable
E                           return os.path.basename(next(builder.build(directory=wheel_directory,
E                       versions=["editable"])))
E                       
E                       ~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E                         File
E                       "/root/.cache/uv/builds-v0/.tmpAuVeyE/lib/python3.13/site-packages/hatchling/builders/plugin/interface.py",
E                       line 92, in build
E                           self.metadata.validate_fields()
E                           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
E                         File
E                       "/root/.cache/uv/builds-v0/.tmpAuVeyE/lib/python3.13/site-packages/hatchling/metadata/core.py",
E                       line 266, in validate_fields
E                           self.core.validate_fields()
E                           ~~~~~~~~~~~~~~~~~~~~~~~~~^^
E                         File
E                       "/root/.cache/uv/builds-v0/.tmpAuVeyE/lib/python3.13/site-packages/hatchling/metadata/core.py",
E                       line 1366, in validate_fields
E                           getattr(self, attribute)
E                           ~~~~~~~^^^^^^^^^^^^^^^^^
E                         File
E                       "/root/.cache/uv/builds-v0/.tmpAuVeyE/lib/python3.13/site-packages/hatchling/metadata/core.py",
E                       line 531, in readme
E                           raise OSError(message)
E                       OSError: Readme file does not exist: README.md
E                 
E                       hint: This usually indicates a problem with the package or the build
E                       environment.
E                 
E               assert False

/tests/test_outputs.py:116: AssertionError
---------------------------- Captured stdout setup -----------------------------
Generating test data.
Generated mini-shard 1/10000
Generated mini-shard 101/10000
Generated mini-shard 201/10000
Generated mini-shard 301/10000
Generated mini-shard 401/10000
Generated mini-shard 501/10000
Generated mini-shard 601/10000
Generated mini-shard 701/10000
Generated mini-shard 801/10000
Generated mini-shard 901/10000
Generated mini-shard 1001/10000
Generated mini-shard 1101/10000
Generated mini-shard 1201/10000
Generated mini-shard 1301/10000
Generated mini-shard 1401/10000
Generated mini-shard 1501/10000
Generated mini-shard 1601/10000
Generated mini-shard 1701/10000
Generated mini-shard 1801/10000
Generated mini-shard 1901/10000
Generated mini-shard 2001/10000
Generated mini-shard 2101/10000
Generated mini-shard 2201/10000
Generated mini-shard 2301/10000
Generated mini-shard 2401/10000
Generated mini-shard 2501/10000
Generated mini-shard 2601/10000
Generated mini-shard 2701/10000
Generated mini-shard 2801/10000
Generated mini-shard 2901/10000
Generated mini-shard 3001/10000
Generated mini-shard 3101/10000
Generated mini-shard 3201/10000
Generated mini-shard 3301/10000
Generated mini-shard 3401/10000
Generated mini-shard 3501/10000
Generated mini-shard 3601/10000
Generated mini-shard 3701/10000
Generated mini-shard 3801/10000
Generated mini-shard 3901/10000
Generated mini-shard 4001/10000
Generated mini-shard 4101/10000
Generated mini-shard 4201/10000
Generated mini-shard 4301/10000
Generated mini-shard 4401/10000
Generated mini-shard 4501/10000
Generated mini-shard 4601/10000
Generated mini-shard 4701/10000
Generated mini-shard 4801/10000
Generated mini-shard 4901/10000
Generated mini-shard 5001/10000
Generated mini-shard 5101/10000
Generated mini-shard 5201/10000
Generated mini-shard 5301/10000
Generated mini-shard 5401/10000
Generated mini-shard 5501/10000
Generated mini-shard 5601/10000
Generated mini-shard 5701/10000
Generated mini-shard 5801/10000
Generated mini-shard 5901/10000
Generated mini-shard 6001/10000
Generated mini-shard 6101/10000
Generated mini-shard 6201/10000
Generated mini-shard 6301/10000
Generated mini-shard 6401/10000
Generated mini-shard 6501/10000
Generated mini-shard 6601/10000
Generated mini-shard 6701/10000
Generated mini-shard 6801/10000
Generated mini-shard 6901/10000
Generated mini-shard 7001/10000
Generated mini-shard 7101/10000
Generated mini-shard 7201/10000
Generated mini-shard 7301/10000
Generated mini-shard 7401/10000
Generated mini-shard 7501/10000
Generated mini-shard 7601/10000
Generated mini-shard 7701/10000
Generated mini-shard 7801/10000
Generated mini-shard 7901/10000
Generated mini-shard 8001/10000
Generated mini-shard 8101/10000
Generated mini-shard 8201/10000
Generated mini-shard 8301/10000
Generated mini-shard 8401/10000
Generated mini-shard 8501/10000
Generated mini-shard 8601/10000
Generated mini-shard 8701/10000
Generated mini-shard 8801/10000
Generated mini-shard 8901/10000
Generated mini-shard 9001/10000
Generated mini-shard 9101/10000
Generated mini-shard 9201/10000
Generated mini-shard 9301/10000
Generated mini-shard 9401/10000
Generated mini-shard 9501/10000
Generated mini-shard 9601/10000
Generated mini-shard 9701/10000
Generated mini-shard 9801/10000
Generated 9898 test files
---------------------------- Captured stderr setup -----------------------------
Generating train split: 0 examples [00:00, ? examples/s]Generating train split: 4628 examples [00:00, 22538.21 examples/s]Generating train split: 9408 examples [00:00, 31060.36 examples/s]Generating train split: 14037 examples [00:00, 36385.34 examples/s]Generating train split: 18508 examples [00:00, 38996.17 examples/s]Generating train split: 27549 examples [00:00, 42197.12 examples/s]Generating train split: 32060 examples [00:00, 42319.00 examples/s]Generating train split: 36548 examples [00:00, 42766.26 examples/s]Generating train split: 41282 examples [00:01, 43304.90 examples/s]Generating train split: 45801 examples [00:01, 42746.11 examples/s]Generating train split: 50561 examples [00:01, 42735.81 examples/s]Generating train split: 55346 examples [00:01, 44012.08 examples/s]Generating train split: 59997 examples [00:01, 44568.25 examples/s]Generating train split: 68767 examples [00:01, 43894.32 examples/s]Generating train split: 73564 examples [00:01, 44281.97 examples/s]Generating train split: 78065 examples [00:01, 44267.48 examples/s]Generating train split: 82514 examples [00:01, 44234.80 examples/s]Generating train split: 87212 examples [00:02, 40419.85 examples/s]Generating train split: 96407 examples [00:02, 42906.33 examples/s]Generating train split: 100921 examples [00:02, 43065.24 examples/s]Generating train split: 110011 examples [00:02, 44033.76 examples/s]Generating train split: 119080 examples [00:02, 44579.94 examples/s]Generating train split: 123717 examples [00:02, 44546.50 examples/s]Generating train split: 132871 examples [00:03, 44949.51 examples/s]Generating train split: 142093 examples [00:03, 45324.61 examples/s]Generating train split: 151171 examples [00:03, 45311.83 examples/s]Generating train split: 155695 examples [00:03, 45204.52 examples/s]Generating train split: 164831 examples [00:03, 45525.10 examples/s]Generating train split: 169418 examples [00:03, 45586.91 examples/s]Generating train split: 178721 examples [00:04, 45510.28 examples/s]Generating train split: 187976 examples [00:04, 46029.57 examples/s]Generating train split: 196759 examples [00:04, 45392.91 examples/s]Generating train split: 205928 examples [00:04, 45608.22 examples/s]Generating train split: 215024 examples [00:04, 45577.94 examples/s]Generating train split: 224136 examples [00:05, 45529.59 examples/s]Generating train split: 233020 examples [00:05, 45238.77 examples/s]Generating train split: 242080 examples [00:05, 45195.18 examples/s]Generating train split: 246733 examples [00:05, 45362.27 examples/s]Generating train split: 255874 examples [00:05, 45393.12 examples/s]Generating train split: 264806 examples [00:06, 44935.33 examples/s]Generating train split: 269418 examples [00:06, 44911.45 examples/s]Generating train split: 278833 examples [00:06, 45526.26 examples/s]Generating train split: 287951 examples [00:06, 45465.47 examples/s]Generating train split: 292646 examples [00:06, 45728.19 examples/s]Generating train split: 301743 examples [00:06, 45418.58 examples/s]Generating train split: 310765 examples [00:07, 45039.69 examples/s]Generating train split: 315368 examples [00:07, 44883.57 examples/s]Generating train split: 324228 examples [00:07, 44718.58 examples/s]Generating train split: 333564 examples [00:07, 45560.08 examples/s]Generating train split: 342797 examples [00:07, 45419.89 examples/s]Generating train split: 351738 examples [00:07, 45015.85 examples/s]Generating train split: 356318 examples [00:08, 44331.64 examples/s]
----------------------------- Captured stdout call -----------------------------
Installing dependencies with uv sync...
uv sync failed: warning: No `requires-python` value found in the workspace. Defaulting to `>=3.13`.
Resolved 3 packages in 5ms
   Building reshape-tools @ file:///app
  × Failed to build `reshape-tools @ file:///app`
  ├─▶ The build backend returned an error
  ╰─▶ Call to `hatchling.build.build_editable` failed (exit status: 1)

      [stderr]
      Traceback (most recent call last):
        File "<string>", line 11, in <module>
          wheel_filename =
      backend.build_editable("/root/.cache/uv/builds-v0/.tmpEHPQ5j", {}, None)
        File
      "/root/.cache/uv/builds-v0/.tmpcev4ra/lib/python3.13/site-packages/hatchling/build.py",
      line 83, in build_editable
          return os.path.basename(next(builder.build(directory=wheel_directory,
      versions=["editable"])))
      
      ~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        File
      "/root/.cache/uv/builds-v0/.tmpcev4ra/lib/python3.13/site-packages/hatchling/builders/plugin/interface.py",
      line 92, in build
          self.metadata.validate_fields()
          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
        File
      "/root/.cache/uv/builds-v0/.tmpcev4ra/lib/python3.13/site-packages/hatchling/metadata/core.py",
      line 266, in validate_fields
          self.core.validate_fields()
          ~~~~~~~~~~~~~~~~~~~~~~~~~^^
        File
      "/root/.cache/uv/builds-v0/.tmpcev4ra/lib/python3.13/site-packages/hatchling/metadata/core.py",
      line 1366, in validate_fields
          getattr(self, attribute)
          ~~~~~~~^^^^^^^^^^^^^^^^^
        File
      "/root/.cache/uv/builds-v0/.tmpcev4ra/lib/python3.13/site-packages/hatchling/metadata/core.py",
      line 531, in readme
          raise OSError(message)
      OSError: Readme file does not exist: README.md

      hint: This usually indicates a problem with the package or the build
      environment.

Running compress script: /app/compress.py /app/c4_test_d18658e2-163f-4e82-a276-799bb9aca777/ /app/c4_test_aacb9dee-4d47-41df-835d-a54d6b97e041/
Compress script failed with return code 1
stdout: 
stderr: warning: No `requires-python` value found in the workspace. Defaulting to `>=3.13`.
   Building reshape-tools @ file:///app
  × Failed to build `reshape-tools @ file:///app`
  ├─▶ The build backend returned an error
  ╰─▶ Call to `hatchling.build.build_editable` failed (exit status: 1)

      [stderr]
      Traceback (most recent call last):
        File "<string>", line 11, in <module>
          wheel_filename =
      backend.build_editable("/root/.cache/uv/builds-v0/.tmp7UtIFd", {}, None)
        File
      "/root/.cache/uv/builds-v0/.tmpAuVeyE/lib/python3.13/site-packages/hatchling/build.py",
      line 83, in build_editable
          return os.path.basename(next(builder.build(directory=wheel_directory,
      versions=["editable"])))
      
      ~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        File
      "/root/.cache/uv/builds-v0/.tmpAuVeyE/lib/python3.13/site-packages/hatchling/builders/plugin/interface.py",
      line 92, in build
          self.metadata.validate_fields()
          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^
        File
      "/root/.cache/uv/builds-v0/.tmpAuVeyE/lib/python3.13/site-packages/hatchling/metadata/core.py",
      line 266, in validate_fields
          self.core.validate_fields()
          ~~~~~~~~~~~~~~~~~~~~~~~~~^^
        File
      "/root/.cache/uv/builds-v0/.tmpAuVeyE/lib/python3.13/site-packages/hatchling/metadata/core.py",
      line 1366, in validate_fields
          getattr(self, attribute)
          ~~~~~~~^^^^^^^^^^^^^^^^^
        File
      "/root/.cache/uv/builds-v0/.tmpAuVeyE/lib/python3.13/site-packages/hatchling/metadata/core.py",
      line 531, in readme
          raise OSError(message)
      OSError: Readme file does not exist: README.md

      hint: This usually indicates a problem with the package or the build
      environment.

=========================== short test summary info ============================
FAILED ../tests/test_outputs.py::test_compress_decompress_workflow - Assertio...
============================== 1 failed in 46.98s ==============================
